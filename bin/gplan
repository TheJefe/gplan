#!/usr/bin/env ruby
#
# This script is used to find all of the planbox story numbers from the git log
# For lesson-player it is dependent on lesson-player being in the directory name for the repo

require 'pathname'
bin_path = Pathname.new(__FILE__).realpath
$:.unshift File.expand_path('../../lib', bin_path)
require 'planbox'
require 'github'

PB_STORY_REGEX=/\[(?:fixes)? *#*([0-9]*)\]/i
GH_PR_REGEX=/Merge pull request #(\d*)/i
# MAIN
prod_branch="production/master"
if Dir.pwd.include? "lesson-player"
        `git fetch origin`
        prod_branch="origin/master"
else
        `git fetch production`
end
list= `git log #{prod_branch}..`
pb_story_ids = list.scan(PB_STORY_REGEX).flatten.uniq
gh_pr_ids = list.scan(GH_PR_REGEX).flatten.uniq
gh_release_notes = Github.get_release_notes gh_pr_ids
release_notes = Planbox.get_release_notes pb_story_ids
puts release_notes
